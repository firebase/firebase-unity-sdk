import argparse
import subprocess
import json
from absl import logging

from integration_testing import gcs

def main():
  parser = argparse.ArgumentParser(description='Build for iOS and tvOS.')
  parser.add_argument('-r', '--test_result', default=None)
  args = parser.parse_args()
  test_result = json.loads(args.test_result)
  logging.info("project_id: %s" % test_result.get("project_id"))
  for app in test_result.get("apps"):
    if app.get("return_code") == 0:
      gcs_dir = app.get("raw_result_link").replace("https://console.developers.google.com/storage/browser", "gs://")
      logging.info("gcs_dir: %s" % gcs_dir)
      logs = _get_testapp_log_text_from_gcs(gcs_dir)
      logging.info("Test result: %s", logs)


def _get_testapp_log_text_from_gcs(gcs_path):
  """Gets the testapp log text generated by game loops."""
  try:
    gcs_contents = _gcs_list_dir(gcs_path)
  except subprocess.CalledProcessError as e:
    logging.error("Unexpected error searching GCS logs:\n%s", e)
    return None
  # The path to the testapp log depends on the platform, device, and scenario
  # being tested. Search for a json file with 'results' in the name to avoid
  # hard-coding too many assumptions about the path. The testapp log should be
  # the only json, but 'results' adds some redundancy in case this changes.
  matching_gcs_logs = [
    line for line in gcs_contents
    if line.endswith(".json") and "results" in line.lower()
  ]
  if not matching_gcs_logs:
    logging.error("Failed to find results log on GCS.")
    return None
  # This assumes testapps only have one scenario. Could change in the future.
  if len(matching_gcs_logs) > 1:
    logging.warning("Multiple scenario logs found.")
  gcs_log = matching_gcs_logs[0]
  try:
    logging.info("Found results log: %s", gcs_log)
    log_text = _gcs_read_file(gcs_log)
    if not log_text:
      logging.warning("Testapp log is empty. App may have crashed.")
    return log_text
  except subprocess.CalledProcessError as e:
    logging.error("Unexpected error reading GCS log:\n%s", e)
    return None


def _gcs_list_dir(gcs_path):
  """Recursively returns a list of contents for a directory on GCS."""
  args = [gcs.GSUTIL, "ls", "-r", gcs_path]
  logging.info("Listing GCS contents: %s", " ".join(args))
  result = subprocess.run(args=args, capture_output=True, text=True, check=True)
  return result.stdout.splitlines()


def _gcs_read_file(gcs_path):
  """Extracts the contents of a file on GCS."""
  gcs_path = gcs.relative_path_to_gs_uri(gcs_path)
  args = [gcs.GSUTIL, "cat", gcs_path]
  logging.info("Reading GCS file: %s", " ".join(args))
  result = subprocess.run(args=args, capture_output=True, text=True, check=True)
  return result.stdout

if __name__ == '__main__':
  main()
